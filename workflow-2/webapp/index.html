<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aether AI - Blue Edition</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #60a5fa;
            --bg-body: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.7);
            --sidebar-width: 280px;
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --error: #ef4444;
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-body);
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(37, 99, 235, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 100% 100%, rgba(29, 78, 216, 0.1) 0%, transparent 40%);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 50;
        }

        .brand {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(to right, #60a5fa, #2563eb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 32px;
        }

        .new-chat-btn {
            background: var(--primary);
            color: white; border: none; padding: 12px; border-radius: 12px;
            font-weight: 600; cursor: pointer; display: flex; align-items: center;
            justify-content: center; gap: 8px; transition: 0.2s;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); margin-bottom: 24px;
        }
        .new-chat-btn:hover { background: #1d4ed8; transform: translateY(-2px); }

        .session-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }

        .session-item {
            padding: 12px 16px; border-radius: 10px; color: var(--text-dim);
            cursor: pointer; font-size: 0.9rem; display: flex;
            justify-content: space-between; align-items: center; transition: 0.2s;
        }
        .session-item:hover { background: rgba(255, 255, 255, 0.05); color: white; }
        .session-item.active {
            background: rgba(37, 99, 235, 0.1); border: 1px solid rgba(37, 99, 235, 0.3);
            color: var(--primary-light);
        }

        .delete-btn {
            opacity: 0; background: transparent; border: none; color: var(--error);
            cursor: pointer; padding: 4px; transition: 0.2s;
        }
        .session-item:hover .delete-btn { opacity: 1; }

        /* --- MAIN AREA --- */
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; }

        header {
            padding: 20px 40px; border-bottom: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px);
        }

        .status-pill {
            display: flex; align-items: center; gap: 8px; font-size: 0.75rem;
            font-weight: 600; background: rgba(34, 197, 94, 0.1); color: #4ade80;
            padding: 6px 12px; border-radius: 100px;
        }
        .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }

        #chat-container { flex: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; gap: 24px; }

        .msg-wrapper { display: flex; width: 100%; animation: fadeIn 0.3s ease; }
        .msg-wrapper.user { justify-content: flex-end; }

        .message {
            max-width: 70%; padding: 16px 20px; border-radius: 18px;
            line-height: 1.6; font-size: 0.95rem; position: relative;
        }
        .user .message { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .ai .message { 
            background: var(--bg-card); border: 1px solid var(--glass-border); 
            color: var(--text-main); border-bottom-left-radius: 4px; 
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1) !important;
            border: 1px solid rgba(239, 68, 68, 0.3) !important;
            color: #fca5a5 !important;
            font-family: monospace; font-size: 0.8rem !important;
        }

        /* Input Section */
        .input-area { padding: 24px 40px; }
        .input-box {
            max-width: 900px; margin: 0 auto; background: var(--bg-card);
            border: 1px solid var(--glass-border); border-radius: 16px;
            padding: 8px 16px; display: flex; align-items: center; gap: 12px;
            transition: 0.3s;
        }
        .input-box:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }

        #user-input {
            flex: 1; background: transparent; border: none; color: white;
            padding: 12px 0; font-size: 1rem;
        }

        #send-btn {
            background: var(--primary); color: white; border: none;
            width: 42px; height: 42px; border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        #send-btn:hover { background: #1d4ed8; transform: scale(1.05); }
        #send-btn:disabled { background: var(--text-dim); cursor: not-allowed; opacity: 0.5; }

        .typing { padding: 0 40px 10px; font-size: 0.85rem; color: var(--primary-light); display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 10px; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand">AETHER AI</div>
        <button class="new-chat-btn" onclick="createNewSession()">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            New Session
        </button>
        <div class="session-list" id="session-list"></div>
    </aside>

    <main class="main-content">
        <header>
            <div>
                <h2 id="current-title" style="font-size: 1.1rem; font-weight: 600;">System Ready</h2>
                <p id="session-id-display" style="font-size: 0.7rem; color: var(--text-dim); margin-top: 4px;"></p>
            </div>
            <div class="status-pill"><div class="status-dot"></div>ONLINE</div>
        </header>

        <div id="chat-container"></div>
        <div id="typing" class="typing">Aether is processing...</div>

        <div class="input-area">
            <div class="input-box">
                <input type="text" id="user-input" placeholder="Tanya sesuatu..." autocomplete="off">
                <button id="send-btn" onclick="sendMessage()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </main>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sessionListEl = document.getElementById('session-list');
        const currentTitleEl = document.getElementById('current-title');
        const sessIdDisplay = document.getElementById('session-id-display');
        const typingIndicator = document.getElementById('typing');
        const sendBtn = document.getElementById('send-btn');

        let currentSessionId = localStorage.getItem('aether_session_id');

        window.onload = () => initApp();

        function initApp() {
            const sessions = getSessions();
            if (sessions.length === 0) {
                createNewSession();
            } else {
                if (!currentSessionId || !sessions.find(s => s.id === currentSessionId)) {
                    currentSessionId = sessions[0].id;
                }
                switchSession(currentSessionId);
            }
        }

        function getSessions() {
            return JSON.parse(localStorage.getItem('aether_sessions')) || [];
        }

        function createNewSession() {
            const id = 'save-' + Math.random().toString(36).substring(2, 9);
            const sessions = getSessions();
            sessions.unshift({ id, title: 'New Conversation' });
            localStorage.setItem('aether_sessions', JSON.stringify(sessions));
            switchSession(id);
        }

        function switchSession(id) {
            currentSessionId = id;
            localStorage.setItem('aether_session_id', id);
            sessIdDisplay.innerText = `ID: ${id}`;
            renderSidebar();
            loadChat(id);
        }

        function renderSidebar() {
            const sessions = getSessions();
            sessionListEl.innerHTML = '';
            sessions.forEach(s => {
                const div = document.createElement('div');
                div.className = `session-item ${s.id === currentSessionId ? 'active' : ''}`;
                div.onclick = () => switchSession(s.id);
                div.innerHTML = `
                    <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${s.title}</span>
                    <button class="delete-btn" onclick="deleteSession(event, '${s.id}')">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                `;
                sessionListEl.appendChild(div);
            });
        }

        function deleteSession(e, id) {
            e.stopPropagation();
            let sessions = getSessions().filter(s => s.id !== id);
            localStorage.setItem('aether_sessions', JSON.stringify(sessions));
            localStorage.removeItem(`history_${id}`);
            initApp();
        }

        function loadChat(id) {
            chatContainer.innerHTML = '';
            const history = JSON.parse(localStorage.getItem(`history_${id}`)) || [];
            const session = getSessions().find(s => s.id === id);
            currentTitleEl.innerText = session ? session.title : "System Ready";
            
            if (history.length === 0) {
                appendMsg('ai', 'Sistem Online. Silahkan masukkan perintah atau pertanyaan Anda.');
            } else {
                history.forEach(m => appendMsg(m.role, m.text, m.isError));
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function appendMsg(role, text, isError = false) {
            const wrapper = document.createElement('div');
            wrapper.className = `msg-wrapper ${role}`;
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isError ? 'error-message' : ''}`;
            msgDiv.innerHTML = text.replace(/\n/g, '<br>');
            wrapper.appendChild(msgDiv);
            chatContainer.appendChild(wrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            appendMsg('user', text);
            userInput.value = '';
            saveMsg(currentSessionId, 'user', text);

            // Update Judul Sesi jika ini pesan pertama
            const history = JSON.parse(localStorage.getItem(`history_${currentSessionId}`)) || [];
            if (history.length === 1) updateTitle(currentSessionId, text);

            setLoading(true);

            try {
                // Catatan: Endpoint ini harus mengarah ke backend Node.js Anda yang memanggil n8n
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        question: text, 
                        sessionId: currentSessionId 
                    })
                });

                const data = await res.json();
                setLoading(false);

                if (res.ok && data.answer) {
                    appendMsg('ai', data.answer);
                    saveMsg(currentSessionId, 'ai', data.answer);
                } else {
                    const errMsg = `ERROR ${res.status}: ${data.message || 'Webhook n8n tidak merespon.'}\n\nHint: Pastikan workflow n8n sudah ACTIVE dan URL yang digunakan adalah URL Production.`;
                    appendMsg('ai', errMsg, true);
                }
            } catch (err) {
                setLoading(false);
                appendMsg('ai', 'FATAL ERROR: Gagal terhubung ke server backend. Periksa konsol untuk detail.', true);
                console.error(err);
            }
        }

        function setLoading(isLoading) {
            typingIndicator.style.display = isLoading ? 'block' : 'none';
            userInput.disabled = isLoading;
            sendBtn.disabled = isLoading;
            if (!isLoading) userInput.focus();
        }

        function saveMsg(id, role, text, isError = false) {
            const history = JSON.parse(localStorage.getItem(`history_${id}`)) || [];
            history.push({ role, text, isError });
            localStorage.setItem(`history_${id}`, JSON.stringify(history));
        }

        function updateTitle(id, text) {
            const sessions = getSessions();
            const s = sessions.find(x => x.id === id);
            if (s) {
                s.title = text.substring(0, 25).toUpperCase() + (text.length > 25 ? '...' : '');
                localStorage.setItem('aether_sessions', JSON.stringify(sessions));
                renderSidebar();
                currentTitleEl.innerText = s.title;
            }
        }

        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>